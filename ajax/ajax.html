<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>ajax</title>
</head>
<body>
    <button class="start">start</button>
    <button class="cancel">cancel</button>
    <script>
        let start = document.getElementsByClassName('start')[0],
            cancel = document.getElementsByClassName('cancel')[0]
        ;
        start.addEventListener('click', function(){
            let xhr = new Request();
            stream(xhr);
            // xhr.startRequest({
            //     type: 'post',
            //     dataType: 'text',
            //     url: '/getContent',
            //     data: {
            //         name: 'name',
            //         password: '123456'
            //     },
            //     timeout: 3000,
            //     timeoutFun: function(){
            //         console.log('this is timeout');
            //     },
            //     abortFun: function(){
            //         console.log('this request is abort!');
            //     }
            // }).then(function(res){
            //     console.log(res);
            // });
            bindCancel(xhr);
        });
        function stream(xhr){
            xhr.startRequest({
                type: 'get',
                dataType: 'blob',
                url: '/stream',
                progressFun: function(e){
                    if(e.lengthComputable){
                        let per = e.loaded / e.total;
                        per = per * 100;
                        console.log(`${per.toFixed(2)}%`);
                    }
                }
            }).then(function(res){
                const src = window.URL.createObjectURL(res);
                const image = new Image();
                image.src = src;
                document.body.appendChild(image);
                console.log(res);
            })
        }
        class Request{
            constructor(){
                let xhr = null;
                if(window.XMLHttpRequest) {
                    xhr = new XMLHttpRequest();
                } else if (window.ActiveXObject) {
                    try {
                        xhr = new ActiveXObject("Msxml2.XMLHTTP");
                    } catch (e) {
                        try {
                            xhr = new ActiveXObject("Microsoft.XMLHTTP");
                        } catch (e) { 
                            throw Error("您的浏览器暂不支持Ajax!");
                        }
                    }
                };
                this.xhr = xhr;
                this.callbacks = {};
            }
            startRequest(options){
                let xhr = this.xhr;
                let {
                    type, dataType, data, url,
                    timeout, timeoutFun,
                    progressFun, abortFun
                } = options;

                if(timeout){
                    xhr.timeout = timeout;
                    xhr.ontimeout = timeoutFun || function(){};
                }
                if(progressFun){
                    xhr.onprogress = progressFun;
                }
                if(abortFun){
                    xhr.onabort = abortFun;
                }
                if(type.toLowerCase() === 'get'){
                    this.get(
                        {type, dataType, data, url}
                    )
                }
                if(type.toLowerCase() === 'post'){
                    this.post(
                        {type, dataType, data, url}
                    )
                }
                return this;
            }
            get(obj){
                let {type, dataType, data, url, isAsync} = obj;
                const xhr = this.xhr;
                const key = this.random();
                this.key = key;
                this.callbacks[key] = null;
                xhr.open(type, url, isAsync || true);
                xhr.onreadystatechange = function(){
                    if(xhr.readyState === 4 && xhr.status === 200){
                        console.log(xhr);
                        this.callbacks[key](xhr.response);
                    }
                }.bind(this);
                xhr.responseType = dataType;
                xhr.send(this.serialize(data));
            }
            post(obj){
                let  {type, dataType, data, url, isAsync} = obj;
                const xhr = this.xhr;
                const key = this.random();
                this.key = key;
                this.callbacks[key] = null;
                xhr.open(type, url, isAsync || true);
                xhr.onreadystatechange = function(){
                    if(xhr.readyState === 4 && xhr.status === 200){
                        this.callbacks[key](xhr.response);
                    }
                }.bind(this);
                xhr.setRequestHeader('content-type','application/x-www-urlencoded');
                xhr.send(this.serialize(data));
            }
            serialize(obj){
                if(!obj){return null;}
                let arr = [];
                for(let k in obj){
                    arr.push(k + '=' + obj[k]);
                }
                return arr.join('&');
            }
            random(){
                return Math.random().toString(16).slice(2);
            }
            then(callback){
                this.callbacks[this.key] = callback;
            }
        }
        function bindCancel(xhr){
            cancel.addEventListener('click', function(){
                // 取消请求
                xhr.xhr.abort();
            })
        }



        //  fetch  https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API/Using_Fetch
        
    </script>
</body>
</html>